---
- hosts: all
  sudo: yes

  tasks:

  - name: update the server
    apt:
      update_cache: yes

  - name: install Node
    apt:
      name: nodejs
      state: present

  - name: install Node legacy
    apt:
      name: nodejs-legacy
      state: present

  - name: install npm
    apt:
      name: npm
      state: present

  - name: install libfontconfig
    apt:
      name: libfontconfig
      state: present

  - name: install grunt
    command: npm install -g grunt-cli

  - name: install dependencies
    npm: path=/opt/software/tdd-js

  - name: ensure tomcat is at the latest version
    apt:
      name: tomcat7
      state: latest

  - name: Change owner of Tomcat installation
    file:
      path: /usr/share/tomcat7/
      owner: tomcat7
      group: tomcat7
      state: directory
      recurse: yes

  - name: ensure tomcat is stopped
    service: name=tomcat7 state=stopped

  - name: download jenkins
    get_url:
      url: http://mirrors.jenkins-ci.org/war/1.631/jenkins.war
      dest: /var/lib/tomcat7/webapps/jenkins.war
      mode: 0644

  - name: Create the /var/lib/jenkins directory
    file:
        path=/var/lib/jenkins/
        mode=0777
        state=directory

  - name: Upload tomcat.conf
    copy:
      src: ./templates/tomcat.conf
      dest: /usr/share/tomcat7/conf/
      owner: tomcat7
      group: tomcat7

  - name: start tomcat to pickup and install Jenkins
    service: name=tomcat7 state=started

  - debug: msg="jenkins should be up and listening to http://<ip>:8080/jenkins"
